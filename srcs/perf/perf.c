#include <grilled_cheese.h>
#include <perf/perf.h>

#define PERF_INTEL_BROADWELL_PMC_COUNT 177

static const struct _pmc_desc perf_intel_broadwell_pmc[PERF_INTEL_BROADWELL_PMC_COUNT] = {
	{ 0x03, 0x02, "LD_BLOCKS.STORE_FORWARD" },
	{ 0x03, 0x08, "LD_BLOCKS.NO_SR" },
	{ 0x05, 0x01, "MISALIGN_MEM_REF.LOADS" },
	{ 0x05, 0x02, "MISALIGN_MEM_REF.STORES" },
	{ 0x07, 0x01, "LD_BLOCKS_PARTIAL.ADDRESS_ALIAS" },
	{ 0x08, 0x01, "DTLB_LOAD_MISSES.MISS_CAUSES_A_WALK" },
	{ 0x08, 0x02, "DTLB_LOAD_MISSES.WALK_COMPLETED_4K" },
	{ 0x08, 0x10, "DTLB_LOAD_MISSES.WALK_DURATION" },
	{ 0x08, 0x20, "DTLB_LOAD_MISSES.STLB_HIT_4K" },
	{ 0x0d, 0x03, "INT_MISC.RECOVERY_CYCLES" },
	{ 0x0e, 0x01, "UOPS_ISSUED.ANY" },
	{ 0x0e, 0x10, "UOPS_ISSUED.FLAGS_MERGE" },
	{ 0x0e, 0x20, "UOPS_ISSUED.SLOW_LEA" },
	{ 0x0e, 0x40, "UOPS_ISSUED.SiNGLE_MUL" },
	{ 0x14, 0x01, "ARITH.FPU_DIV_ACTIVE" },
	{ 0x24, 0x21, "L2_RQSTS.DEMAND_DATA_RD_MISS" },
	{ 0x24, 0x41, "L2_RQSTS.DEMAND_DATA_RD_HIT" },
	{ 0x24, 0x50, "L2_RQSTS.L2_PF_HIT" },
	{ 0x24, 0x30, "L2_RQSTS.L2_PF_MISS" },
	{ 0x24, 0xe1, "L2_RQSTS.ALL_DEMAND_DATA_RD" },
	{ 0x24, 0xe2, "L2_RQSTS.ALL_RFO" },
	{ 0x24, 0xe4, "L2_RQSTS.ALL_CODE_RD" },
	{ 0x24, 0xf8, "L2_RQSTS.ALL_PF" },
	{ 0x27, 0x50, "L2_DEMAND_RQSTS.WB_HIT" },
	{ 0x2e, 0x4f, "LONGEST_LAT_CACHE.REFERENCE" },
	{ 0x2e, 0x41, "LONGEST_LAT_CACHE.MISS" },
	{ 0x3c, 0x00, "CPU_CLK_UNHALTED.THREAD_P" },
	{ 0x3c, 0x01, "CPU_CLK_THREAD_UNHALTED.REF_XCLK" },
	{ 0x48, 0x01, "L1D_PEND_MISS.PENDING" },
	{ 0x49, 0x01, "DTLB_STORE_MISSES.MISS_CAUSES_A_WALK" },
	{ 0x49, 0x02, "DTLB_STORE_MISSES.WALK_COMPLETED_4K" },
	{ 0x49, 0x10, "DTLB_STORE_MISSES.WALK_DURATION" },
	{ 0x49, 0x20, "DTLB_STORE_MISSES.STLB_HIT_4K" },
	{ 0x4c, 0x02, "LOAD_HIT_PRE.HW_PF" },
	{ 0x4f, 0x10, "EPT.WALK_CYCLES" },
	{ 0x51, 0x01, "L1D.REPLACEMENT" },
	{ 0x58, 0x04, "MOVE_ELIMINATION.INT_NOT_ELIMINATED" },
	{ 0x58, 0x08, "MOVE_ELIMINATION.SIMD_NOT_ELIMINATED" },
	{ 0x58, 0x01, "MOVE_ELIMINATION.INT_ELIMINATED" },
	{ 0x58, 0x02, "MOVE_ELIMINATION.SIMD_ELIMINATED" },
	{ 0x5c, 0x01, "CPL_CYCLES.RING0" },
	{ 0x5c, 0x02, "CPL_CYCLES.RING123" },
	{ 0x5e, 0x01, "RS_EVENTS.EMPTY_CYCLES" },
	{ 0x60, 0x01, "OFFCORE_REQUESTS_OUTSTANDING.DEMAND_DATA_RD" },
	{ 0x60, 0x02, "OFFCORE_REQUESTS_OUTSTANDING.DEMAND_CODE_RD" },
	{ 0x60, 0x04, "OFFCORE_REQUESTS_OUTSTANDING.DEMAND_RFO" },
	{ 0x60, 0x08, "OFFCORE_REQUESTS_OUTSTANDING.ALL_DATA_RD" },
	{ 0x63, 0x01, "LOCK_CYCLES.SPLIT_LOCK_UC_LOCK_DURATION" },
	{ 0x63, 0x02, "LOCK_CYCLES.CACHE_LOCK_DURATION" },
	{ 0x79, 0x02, "IDQ.EMPTY" },
	{ 0x79, 0x04, "IDQ.MITE_UOPS" },
	{ 0x79, 0x08, "IDQ.DSB_UOPS" },
	{ 0x79, 0x10, "IDQ.MS_DSB_UOPS" },
	{ 0x79, 0x20, "IDQ.MS_MITE_UOPS" },
	{ 0x79, 0x30, "IDQ.MS_UOPS" },
	{ 0x79, 0x18, "IDQ.ALL_DSB_CYCLES_ANY_UOPS" },
	{ 0x79, 0x18, "IDQ.ALL_DSB_CYCLES_4_UOPS" },
	{ 0x79, 0x24, "IDQ.ALL_MITE_CYCLES_ANY_UOPS" },
	{ 0x79, 0x24, "IDQ.ALL_MITE_CYCLES_4_UOPS" },
	{ 0x79, 0x3c, "IDQ.MITE_ALL_UOPS" },
	{ 0x80, 0x02, "ICACHE.MISSES" },
	{ 0x85, 0x01, "ITLB_MISSES.MISS_CAUSES_A_WALK" },
	{ 0x85, 0x02, "ITLB_MISSES.WALK_COMPLETED_4K" },
	{ 0x85, 0x10, "ITLB_MISSES.WALK_DURATION" },
	{ 0x85, 0x20, "ITLB_MISSES.STLB_HIT_4K" },
	{ 0x87, 0x01, "ILD_STALL.LCP" },
	{ 0x88, 0x01, "BR_INST_EXEC.COND" },
	{ 0x88, 0x02, "BR_INST_EXEC.DIRECT_JMP" },
	{ 0x88, 0x04, "BR_INST_EXEC.INDIRECT_JMP_NON_CALL_RET" },
	{ 0x88, 0x08, "BR_INST_EXEC.RETURN_NEAR" },
	{ 0x88, 0x10, "BR_INST_EXEC.DIRECT_NEAR_CALL" },
	{ 0x88, 0x20, "BR_INST_EXEC.INDIRECT_NEAR_CALL" },
	{ 0x88, 0x40, "BR_INST_EXEC.NONTAKEN" },
	{ 0x88, 0x80, "BR_INST_EXEC.TAKEN" },
	{ 0x88, 0xff, "BR_INST_EXEC.ALL_BRANCHES" },
	{ 0x89, 0x01, "BR_MISP_EXEC.COND" },
	{ 0x89, 0x04, "BR_MISP_EXEC.INDIRECT_JMP_NON_CALL_RET" },
	{ 0x89, 0x08, "BR_MISP_EXEC.RETURN_NEAR" },
	{ 0x89, 0x10, "BR_MISP_EXEC.DIRECT_NEAR_CALL" },
	{ 0x89, 0x20, "BR_MISP_EXEC.INDIRECT_NEAR_CALL" },
	{ 0x89, 0x40, "BR_MISP_EXEC.NONTAKEN" },
	{ 0x89, 0x80, "BR_MISP_EXEC.TAKEN" },
	{ 0x89, 0xff, "BR_MISP_EXEC.ALL_BRANCHES" },
	{ 0x9c, 0x01, "IDQ_UOPS_NOT_DELIVERED.CORE" },
	{ 0xa1, 0x01, "UOPS_DISPATCHED_PORT.PORT_0" },
	{ 0xa1, 0x02, "UOPS_DISPATCHED_PORT.PORT_1" },
	{ 0xa1, 0x04, "UOPS_DISPATCHED_PORT.PORT_2" },
	{ 0xa1, 0x08, "UOPS_DISPATCHED_PORT.PORT_3" },
	{ 0xa1, 0x10, "UOPS_DISPATCHED_PORT.PORT_4" },
	{ 0xa1, 0x20, "UOPS_DISPATCHED_PORT.PORT_5" },
	{ 0xa1, 0x40, "UOPS_DISPATCHED_PORT.PORT_6" },
	{ 0xa1, 0x80, "UOPS_DISPATCHED_PORT.PORT_7" },
	{ 0xa2, 0x01, "RESOURCE_STALLS.ANY" },
	{ 0xa2, 0x04, "RESOURCE_STALLS.RS" },
	{ 0xa2, 0x08, "RESOURCE_STALLS.SB" },
	{ 0xa2, 0x10, "RESOURCE_STALLS.ROB" },
	{ 0xa8, 0x01, "LSD.UOPS" },
	{ 0xab, 0x02, "DSB2MITE_SWITCHES.PENALTY_CYCLES" },
	{ 0xae, 0x01, "ITLB.ITLB_FLUSH" },
	{ 0xb0, 0x01, "OFFCORE_REQUESTS.DEMAND_DATA_RD" },
	{ 0xb0, 0x02, "OFFCORE_REQUESTS.DEMAND_CODE_RD" },
	{ 0xb0, 0x04, "OFFCORE_REQUESTS.DEMAND_RFO" },
	{ 0xb0, 0x08, "OFFCORE_REQUESTS.ALL_DATA_RD" },
	{ 0xb1, 0x01, "UOPS_EXECUTED.THREAD" },
	{ 0xb1, 0x02, "UOPS_EXECUTED.CORE" },
	{ 0xb7, 0x01, "OFF_CORE_RESPONSE_0" },
	{ 0xbb, 0x01, "OFF_CORE_RESPONSE_1" },
	{ 0xbc, 0x11, "PAGE_WALKER_LOADS.DTLB_L1" },
	{ 0xbc, 0x21, "PAGE_WALKER_LOADS.ITLB_L1" },
	{ 0xbc, 0x12, "PAGE_WALKER_LOADS.DTLB_L2" },
	{ 0xbc, 0x22, "PAGE_WALKER_LOADS.ITLB_L2" },
	{ 0xbc, 0x14, "PAGE_WALKER_LOADS.DTLB_L3" },
	{ 0xbc, 0x24, "PAGE_WALKER_LOADS.ITLB_L3" },
	{ 0xbc, 0x18, "PAGE_WALKER_LOADS.DTLB_MEMORY" },
	{ 0xc0, 0x00, "INST_RETIRED.ANY_P" },
	{ 0xc0, 0x01, "INST_RETIRED.PREC_DIST" },
	{ 0xc0, 0x02, "INST_RETIRED.X87" },
	{ 0xc1, 0x08, "OTHER_ASSISTS.AVX_TO_SSE" },
	{ 0xc1, 0x10, "OTHER_ASSISTS.SSE_TO_AVX" },
	{ 0xc1, 0x40, "OTHER_ASSISTS.ANY_WB_ASSIST" },
	{ 0xc2, 0x01, "UOPS_RETIRED.ALL" },
	{ 0xc2, 0x02, "UOPS_RETIRED.RETIRE_SLOTS" },
	{ 0xc3, 0x01, "MACHINE_CLEARS.CYCLES" },
	{ 0xc3, 0x02, "MACHINE_CLEARS.MEMORY_ORDERING" },
	{ 0xc3, 0x04, "MACHINE_CLEARS.SMC" },
	{ 0xc3, 0x20, "MACHINE_CLEARS.MASKMOV" },
	{ 0xc4, 0x00, "BR_INST_RETIRED.ALL_BRANCHES" },
	{ 0xc4, 0x01, "BR_INST_RETIRED.CONDITIONAL" },
	{ 0xc4, 0x02, "BR_INST_RETIRED.NEAR_CALL" },
	{ 0xc4, 0x04, "BR_INST_RETIRED.ALL_BRANCHES" },
	{ 0xc4, 0x08, "BR_INST_RETIRED.NEAR_RETURN" },
	{ 0xc4, 0x10, "BR_INST_RETIRED.NOT_TAKEN" },
	{ 0xc4, 0x20, "BR_INST_RETIRED.NEAR_TAKEN" },
	{ 0xc4, 0x40, "BR_INST_RETIRED.FAR_BRANCH" },
	{ 0xc5, 0x00, "BR_MISP_RETIRED.ALL_BRANCHES" },
	{ 0xc5, 0x01, "BR_MISP_RETIRED.CONDITIONAL" },
	{ 0xc5, 0x04, "BR_MISP_RETIRED.ALL_BRANCHES" },
	{ 0xca, 0x02, "FP_ASSIST.X87_OUTPUT" },
	{ 0xca, 0x04, "FP_ASSIST.X87_INPUT" },
	{ 0xca, 0x08, "FP_ASSIST.SIMD_OUTPUT" },
	{ 0xca, 0x10, "FP_ASSIST.SIMD_INPUT" },
	{ 0xca, 0x1e, "FP_ASSIST.ANY" },
	{ 0xcc, 0x20, "ROB_MISC_EVENTS.LBR_INSERTS" },
	{ 0xcd, 0x01, "MEM_TRANS_RETIRED.LOAD_LATENCY" },
	{ 0xd0, 0x11, "MEM_UOPS_RETIRED.STLB_MISS_LOADS" },
	{ 0xd0, 0x12, "MEM_UOPS_RETIRED.STLB_MISS_STORES" },
	{ 0xd0, 0x21, "MEM_UOPS_RETIRED.LOCK_LOADS" },
	{ 0xd0, 0x41, "MEM_UOPS_RETIRED.SPLIT_LOADS" },
	{ 0xd0, 0x42, "MEM_UOPS_RETIRED.SPLIT_STORES" },
	{ 0xd0, 0x81, "MEM_UOPS_RETIRED.ALL_LOADS" },
	{ 0xd0, 0x82, "MEM_UOPS_RETIRED.ALL_STORES" },
	{ 0xd1, 0x01, "MEM_LOAD_UOPS_RETIRED.L1_HIT" },
	{ 0xd1, 0x02, "MEM_LOAD_UOPS_RETIRED.L2_HIT" },
	{ 0xd1, 0x04, "MEM_LOAD_UOPS_RETIRED.L3_HIT" },
	{ 0xd1, 0x08, "MEM_LOAD_UOPS_RETIRED.L1_MISS" },
	{ 0xd1, 0x10, "MEM_LOAD_UOPS_RETIRED.L2_MISS" },
	{ 0xd1, 0x20, "MEM_LOAD_UOPS_RETIRED.L3_MISS" },
	{ 0xd1, 0x40, "MEM_LOAD_UOPS_RETIRED.HIT_LFB" },
	{ 0xd2, 0x01, "MEM_LOAD_UOPS_L3_HIT_RETIRED.XSNP_MISS" },
	{ 0xd2, 0x02, "MEM_LOAD_UOPS_L3_HIT_RETIRED.XSNP_HIT" },
	{ 0xd2, 0x04, "MEM_LOAD_UOPS_L3_HIT_RETIRED.XSNP_HITM" },
	{ 0xd2, 0x08, "MEM_LOAD_UOPS_L3_HIT_RETIRED.XSNP_NONE" },
	{ 0xd3, 0x01, "MEM_LOAD_UOPS_L3_MISS_RETIRED.LOCAL_DRAM" },
	{ 0xf0, 0x01, "L2_TRANS.DEMAND_DATA_RD" },
	{ 0xf0, 0x02, "L2_TRANS.RFO" },
	{ 0xf0, 0x04, "L2_TRANS.CODE_RD" },
	{ 0xf0, 0x08, "L2_TRANS.ALL_PF" },
	{ 0xf0, 0x10, "L2_TRANS.L1D_WB" },
	{ 0xf0, 0x20, "L2_TRANS.L2_FILL" },
	{ 0xf0, 0x40, "L2_TRANS.L2_WB" },
	{ 0xf0, 0x80, "L2_TRANS.ALL_REQUESTS" },
	{ 0xf1, 0x01, "L2_LINES_IN.I" },
	{ 0xf1, 0x02, "L2_LINES_IN.S" },
	{ 0xf1, 0x04, "L2_LINES_IN.E" },
	{ 0xf1, 0x07, "L2_LINES_IN.ALL" },
	{ 0xf2, 0x05, "L2_LINES_OUT.DEMAND_CLEAN" },
	{ 0x54, 0x02, "TX_MEM.ABORT_CAPACITY" },
};

rstate_t
perf_get_pmc_by_id(
		unsigned int             perf_id,
		const struct _pmc_desc **pmc)
{
	RSTATE_LOCALS;

	RSCHECK(perf_id < PERF_INTEL_BROADWELL_PMC_COUNT,
			"Performance counter ID out of range");

	*pmc = &perf_intel_broadwell_pmc[perf_id];

	rstate_ret = rstate = RSTATE_SUCCESS;
cleanup:
	RSTATE_RETURN;
}

